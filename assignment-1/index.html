<!DOCTYPE html>
<html lang="en">
<body>
<div id="container"></div>
<script src="https://d3js.org/d3.v7.min.js"></script>
<script type="module">

// Declare the chart dimensions and margins.
const width = 640;
const height = 600;
const marginTop = 20;
const marginRight = 20;
const marginBottom = 30;
const marginLeft = 80;

const months = [
    "January", "February", "March", "April", "May", "June",
    "July", "August", "September", "October", "November", "December"
];

// Load the data and process it.
d3.csv("temperature_daily.csv", d => {
    const date = new Date(d.date);
    return {
        date,
        year: date.getUTCFullYear(),
        month: date.getUTCMonth(), // 0-11
        monthName: months[date.getUTCMonth()],
        maxTemp: +d.max_temperature,
        minTemp: +d.min_temperature
    };
}).then(data => {

    const monthly = d3.rollups(
        data,
        v => ({
            maxTemp: d3.mean(v, d => d.maxTemp),
            minTemp: d3.mean(v, d => d.minTemp), 
            daily: [...v].sort((a, b) => d3.ascending(a.date, b.date))
        }),
        d => d.year,
        d => d.month
    ).flatMap(([year, monthData]) => monthData.map(([month, values]) => ({
        year,
        month,
        monthName: months[month],
        maxTemp: values.maxTemp,
        minTemp: values.minTemp,
        daily: values.daily
    }))
    )

    console.log(monthly);

    const years = Array.from(new Set(monthly.map(d => d.year))).sort(d3.ascending);

    // Create the SVG container.
    const svg = d3.create("svg")
        .attr("width", width)
        .attr("height", height);
    
    // Declare the x (horizontal position) scale.
    const visibleYears = years.slice(-10); // Get the last 10 years

    const x = d3.scaleBand()
    .domain(visibleYears)
    .range([marginLeft, width - marginRight])
    .padding(0.1);

    const filteredMonthly = monthly.filter(d => visibleYears.includes(d.year));

    // Declare the y (vertical position) scale.
    const y = d3.scaleBand()
    .domain(months)
    .range([marginTop, height - marginBottom])
    .padding(0.1);

    // Add the x-axis.
    svg.append("g")
        .attr("transform", `translate(0, ${marginTop})`)
        .call(d3.axisTop(x));

    // Add the y-axis.
    svg.append("g")
        .attr("transform", `translate(${marginLeft},0)`)
        .call(d3.axisLeft(y));

    // Append the SVG element.
    const container = document.getElementById("container");
    container.append(svg.node());

    // Creating grid cells
    let currentMetric = "maxTemp"; // Default metric to display
    
    const color = d3.scaleSequential(d3.interpolateRdYlBu);
    
    function updateColorDomain() {
        color.domain(d3.extent(monthly, d => d[currentMetric]));
    }
    
    updateColorDomain();
    
    const cells = svg.selectAll("g.cell")
        .data(filteredMonthly)
        .join("g")
        .attr("class", "cell")
        .attr("transform", d => `translate(${x(d.year)}, ${y(d.monthName)})`);

    cells.append("rect")
        .attr("width", x.bandwidth())
        .attr("height", y.bandwidth())
        .attr("fill", d => color(d[currentMetric]));

});




</script>
</body>
</html>
